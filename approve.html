<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Approve Order | GAMING X LIGHT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:Arial;
  background:radial-gradient(circle at top,#1c1030,#0b0b0f 70%);
  color:#fff;
}
.card{
  max-width:420px;
  width:100%;
  background:#141414;
  padding:26px;
  border-radius:18px;
  text-align:center;
  box-shadow:0 0 35px rgba(168,85,247,.6);
}
.logo{width:110px;margin-bottom:10px}
.info{
  background:#0f0f0f;
  padding:14px;
  border-radius:12px;
  margin-bottom:18px;
  text-align:left;
  font-size:14px;
}
.info b{color:#a855f7}
button{
  width:100%;
  padding:15px;
  border:none;
  border-radius:12px;
  background:#22c55e;
  color:#000;
  font-weight:900;
  cursor:pointer;
}
button:disabled{
  background:#555;
  color:#aaa;
}
.status{
  margin-top:14px;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="card">
  <img src="logo.png" class="logo">

  <h2>Order Approval</h2>

  <div class="info">
    <p><b>Order ID:</b> <span id="oid">-</span></p>
    <p><b>Product:</b> <span id="pname">-</span></p>
    <p><b>Price:</b> ₹<span id="price">-</span></p>
    <p><b>Email:</b> <span id="email">-</span></p>
  </div>

  <button id="approveBtn">✅ APPROVE & SEND EMAIL</button>
  <div class="status" id="status"></div>
</div>

<script>
/* -------- SAFE INIT -------- */
emailjs.init("Jq3n4jPZiiiwdgY7_");

/* -------- PARAMS -------- */
const p = new URLSearchParams(window.location.search);

const orderId = p.get("order") || "N/A";
const product = decodeURIComponent(p.get("product") || "");
const price   = p.get("price") || "";
const email   = p.get("email") || "";

document.getElementById("oid").innerText = orderId;
document.getElementById("pname").innerText = product;
document.getElementById("price").innerText = price;
document.getElementById("email").innerText = email;

const btn = document.getElementById("approveBtn");
const status = document.getElementById("status");

/* -------- LOCK SYSTEM -------- */
let done = JSON.parse(localStorage.getItem("approved") || "[]");
if(done.includes(orderId)){
  btn.disabled = true;
  btn.innerText = "✅ ALREADY APPROVED";
  status.innerText = "Email already sent.";
  status.style.color = "#22c55e";
}

/* -------- CLICK -------- */
btn.onclick = async () => {
  if(!email){
    alert("Email missing in URL");
    return;
  }

  btn.disabled = true;
  btn.innerText = "SENDING...";

  try{
    await emailjs.send(
      "service_bepfzoh",
      "customer_reply",
      {
        order_id: orderId,
        product: product,
        price: price,
        status: "APPROVED",
        to_email: email
      }
    );

    done.push(orderId);
    localStorage.setItem("approved", JSON.stringify(done));

    btn.innerText = "✅ APPROVED";
    status.innerText = "Customer email sent successfully.";
    status.style.color = "#22c55e";

  }catch(e){
    console.error(e);
    alert("EmailJS error. Check console.");
    btn.disabled = false;
    btn.innerText = "✅ APPROVE & SEND EMAIL";
  }
};
</script>

</body>
</html>
